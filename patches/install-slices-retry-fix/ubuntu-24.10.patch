From a9dc6f0b354e1231f18caafa97bbde0233edf6ae Mon Sep 17 00:00:00 2001
From: "copilot-swe-agent[bot]" <198982749+Copilot@users.noreply.github.com>
Date: Mon, 3 Nov 2025 11:03:18 +0000
Subject: [PATCH] ci: add retry mechanism to install-slices helper in spread
 tests

---
 tests/spread/lib/install-slices | 28 ++++++++++++++++++++++++++--
 1 file changed, 26 insertions(+), 2 deletions(-)

diff --git a/tests/spread/lib/install-slices b/tests/spread/lib/install-slices
index c67f997..2a151d9 100755
--- a/tests/spread/lib/install-slices
+++ b/tests/spread/lib/install-slices
@@ -5,6 +5,30 @@
 # Returns the path of the chiselled rootfs
 
 tmpdir="$(mktemp -d)"
-
 echo "${tmpdir}"
-chisel cut --release "$PROJECT_PATH" --root "$tmpdir" $@
+
+max_attempts=3
+attempt=1
+fetch_error="error: cannot fetch from archive"
+
+while [ $attempt -le $max_attempts ]; do
+    output=$(chisel cut --release "$PROJECT_PATH" --root "$tmpdir" "$@" 2>&1)
+    exit_code=$?
+    
+    if [ $exit_code -eq 0 ]; then
+        exit 0
+    fi
+    
+    # Check if it's a fetch error that we should retry
+    if echo "$output" | grep -q "$fetch_error"; then
+        if [ $attempt -lt $max_attempts ]; then
+            echo "Fetch error on attempt $attempt/$max_attempts, retrying..." >&2
+            ((attempt++))
+            continue
+        fi
+    fi
+    
+    # If we get here, either it's not a fetch error or we're out of retries
+    echo "$output" >&2
+    exit $exit_code
+done
-- 
2.51.2

